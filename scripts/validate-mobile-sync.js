#!/usr/bin/env node

/**
 * Script de Valida√ß√£o de Sincroniza√ß√£o Mobile - AirPlus Aviation
 * Verifica se todas as vers√µes (PWA, Android, iOS) est√£o sincronizadas
 */

import fs from "fs";
import path from "path";

const REQUIRED_TABLES = [
  "aircraft",
  "employees",
  "cleaning_forms",
  "tasks",
  "flight_sheets",
  "system_settings",
  "user_profiles",
  "roles",
  "user_roles",
  "photo_evidence",
  "intervention_types",
  "shift_configs",
  "location_configs",
  "migration_history",
  "user_activity_logs",
  "permissions",
  "role_permissions",
  "notifications",
  "file_attachments",
  "qr_codes",
  "cleaning_form_employees",
];

const OFFLINE_TABLES = [
  "aircraft",
  "employees",
  "cleaning_forms",
  "cleaning_form_employees",
  "system_settings",
  "file_attachments",
  "sync_queue",
  "offline_metadata",
  "migration_history",
  "photo_evidence",
  "intervention_types",
  "shift_configs",
  "location_configs",
  "notifications",
  "qr_codes",
  "user_activity_logs",
  "tasks",
  "flight_sheets",
];

console.log("üîç VALIDA√á√ÉO DE SINCRONIZA√á√ÉO MOBILE - AIRPLUS AVIATION");
console.log("========================================================\n");

let errors = [];
let warnings = [];

// 1. Verificar migra√ß√µes Supabase
console.log("üìä Verificando Migra√ß√µes Supabase...");
const migrationDir = "supabase/migrations";
if (fs.existsSync(migrationDir)) {
  const migrations = fs
    .readdirSync(migrationDir)
    .filter((file) => file.endsWith(".sql"))
    .sort();

  console.log(`‚úÖ Encontradas ${migrations.length} migra√ß√µes:`);
  migrations.forEach((migration) => {
    console.log(`   - ${migration}`);
  });

  // Verificar se temos as migra√ß√µes VFINAL
  const vfinalMigrations = migrations.filter(
    (m) => m.includes("vfinal") || m.includes("20241220"),
  );
  if (vfinalMigrations.length < 4) {
    errors.push(
      "‚ùå Migra√ß√µes VFINAL incompletas. Esperadas: 4, encontradas: " +
        vfinalMigrations.length,
    );
  } else {
    console.log("‚úÖ Migra√ß√µes VFINAL completas");
  }
} else {
  errors.push("‚ùå Diret√≥rio de migra√ß√µes n√£o encontrado");
}

console.log("\n");

// 2. Verificar sistema offline (IndexedDB)
console.log("üíæ Verificando Sistema Offline (IndexedDB)...");
const migrationsFile = "client/lib/migrations.ts";
if (fs.existsSync(migrationsFile)) {
  const content = fs.readFileSync(migrationsFile, "utf8");

  // Verificar vers√£o do banco
  if (content.includes("const version = 2")) {
    console.log("‚úÖ Vers√£o do banco offline atualizada (v2)");
  } else {
    errors.push("‚ùå Vers√£o do banco offline n√£o atualizada (esperado v2)");
  }

  // Verificar se todas as tabelas offline est√£o presentes
  let missingTables = [];
  OFFLINE_TABLES.forEach((table) => {
    if (!content.includes(`"${table}"`)) {
      missingTables.push(table);
    }
  });

  if (missingTables.length === 0) {
    console.log(
      `‚úÖ Todas as ${OFFLINE_TABLES.length} tabelas offline configuradas`,
    );
  } else {
    errors.push(`‚ùå Tabelas offline faltando: ${missingTables.join(", ")}`);
  }
} else {
  errors.push("‚ùå Arquivo migrations.ts n√£o encontrado");
}

console.log("\n");

// 3. Verificar servi√ßo de sincroniza√ß√£o inteligente
console.log("üîÑ Verificando Servi√ßo de Sincroniza√ß√£o...");
const syncFile = "client/lib/intelligent-sync-service.ts";
if (fs.existsSync(syncFile)) {
  const content = fs.readFileSync(syncFile, "utf8");

  // Verificar vers√£o do banco de sincroniza√ß√£o
  if (content.includes("this.version(2)")) {
    console.log("‚úÖ Servi√ßo de sincroniza√ß√£o atualizado (v2)");
  } else {
    errors.push("‚ùå Servi√ßo de sincroniza√ß√£o n√£o atualizado");
  }

  // Verificar se novas tabelas est√£o inclu√≠das
  const newTables = [
    "photoEvidence",
    "interventionTypes",
    "shiftConfigs",
    "locationConfigs",
    "notifications",
    "qrCodes",
    "tasks",
    "flightSheets",
  ];
  let missingInSync = [];
  newTables.forEach((table) => {
    if (!content.includes(`${table}!: Table`)) {
      missingInSync.push(table);
    }
  });

  if (missingInSync.length === 0) {
    console.log("‚úÖ Todas as novas tabelas inclu√≠das na sincroniza√ß√£o");
  } else {
    errors.push(
      `‚ùå Tabelas faltando na sincroniza√ß√£o: ${missingInSync.join(", ")}`,
    );
  }
} else {
  errors.push("‚ùå Arquivo intelligent-sync-service.ts n√£o encontrado");
}

console.log("\n");

// 4. Verificar configura√ß√£o PWA
console.log("üì± Verificando Configura√ß√£o PWA...");
const manifestFile = "public/manifest.json";
if (fs.existsSync(manifestFile)) {
  try {
    const manifest = JSON.parse(fs.readFileSync(manifestFile, "utf8"));

    if (
      manifest.name === "AirPlus Aviation - Sistema de Limpeza de Aeronaves"
    ) {
      console.log("‚úÖ Manifest PWA configurado corretamente");
    } else {
      warnings.push("‚ö†Ô∏è Nome do PWA pode estar desatualizado");
    }

    if (manifest.icons && manifest.icons.length >= 7) {
      console.log("‚úÖ Icons PWA completos");
    } else {
      warnings.push("‚ö†Ô∏è Icons PWA podem estar incompletos");
    }
  } catch (e) {
    errors.push("‚ùå Manifest PWA inv√°lido");
  }
} else {
  errors.push("‚ùå Manifest PWA n√£o encontrado");
}

console.log("\n");

// 5. Verificar configura√ß√£o Capacitor
console.log("‚ö° Verificando Configura√ß√£o Capacitor...");
const capacitorFile = "capacitor.config.ts";
if (fs.existsSync(capacitorFile)) {
  const content = fs.readFileSync(capacitorFile, "utf8");

  if (content.includes("com.airplus.aviation")) {
    console.log("‚úÖ App ID configurado corretamente");
  } else {
    errors.push("‚ùå App ID do Capacitor incorreto");
  }

  if (content.includes("AirPlus Aviation")) {
    console.log("‚úÖ Nome do app configurado");
  } else {
    errors.push("‚ùå Nome do app n√£o configurado");
  }

  const requiredPlugins = ["Camera", "Filesystem", "Network", "Preferences"];
  let missingPlugins = [];
  requiredPlugins.forEach((plugin) => {
    if (!content.includes(plugin)) {
      missingPlugins.push(plugin);
    }
  });

  if (missingPlugins.length === 0) {
    console.log("‚úÖ Plugins Capacitor configurados");
  } else {
    warnings.push(
      `‚ö†Ô∏è Plugins podem estar faltando: ${missingPlugins.join(", ")}`,
    );
  }
} else {
  errors.push("‚ùå Arquivo capacitor.config.ts n√£o encontrado");
}

console.log("\n");

// 6. Verificar scripts de build
console.log("üî® Verificando Scripts de Build...");
const packageFile = "package.json";
if (fs.existsSync(packageFile)) {
  try {
    const pkg = JSON.parse(fs.readFileSync(packageFile, "utf8"));

    const requiredScripts = [
      "build:production",
      "build:mobile",
      "build:android",
      "build:ios",
      "build:mobile:all",
      "mobile:sync",
    ];

    let missingScripts = [];
    requiredScripts.forEach((script) => {
      if (!pkg.scripts[script]) {
        missingScripts.push(script);
      }
    });

    if (missingScripts.length === 0) {
      console.log("‚úÖ Scripts de build mobile configurados");
    } else {
      errors.push(`‚ùå Scripts faltando: ${missingScripts.join(", ")}`);
    }

    // Verificar depend√™ncias Capacitor
    const capacitorDeps = [
      "@capacitor/core",
      "@capacitor/cli",
      "@capacitor/android",
      "@capacitor/ios",
      "@capacitor/camera",
      "@capacitor/filesystem",
      "@capacitor/network",
    ];

    let missingDeps = [];
    capacitorDeps.forEach((dep) => {
      if (!pkg.dependencies[dep]) {
        missingDeps.push(dep);
      }
    });

    if (missingDeps.length === 0) {
      console.log("‚úÖ Depend√™ncias Capacitor instaladas");
    } else {
      warnings.push(
        `‚ö†Ô∏è Depend√™ncias podem estar faltando: ${missingDeps.join(", ")}`,
      );
    }
  } catch (e) {
    errors.push("‚ùå package.json inv√°lido");
  }
} else {
  errors.push("‚ùå package.json n√£o encontrado");
}

console.log("\n");

// 7. Verificar diret√≥rios mobile
console.log("üìÇ Verificando Estrutura Mobile...");
const androidDir = "android";
const iosDir = "ios";

if (fs.existsSync(androidDir)) {
  console.log("‚úÖ Projeto Android presente");

  if (fs.existsSync(path.join(androidDir, "app/build.gradle"))) {
    console.log("‚úÖ Configura√ß√£o Android v√°lida");
  } else {
    warnings.push("‚ö†Ô∏è Configura√ß√£o Android pode estar incompleta");
  }
} else {
  warnings.push(
    "‚ö†Ô∏è Projeto Android n√£o encontrado (executar: npx cap add android)",
  );
}

if (fs.existsSync(iosDir)) {
  console.log("‚úÖ Projeto iOS presente");

  if (fs.existsSync(path.join(iosDir, "App/App.xcodeproj"))) {
    console.log("‚úÖ Configura√ß√£o iOS v√°lida");
  } else {
    warnings.push("‚ö†Ô∏è Configura√ß√£o iOS pode estar incompleta");
  }
} else {
  warnings.push("‚ö†Ô∏è Projeto iOS n√£o encontrado (executar: npx cap add ios)");
}

console.log("\n");

// 8. Resultados finais
console.log("üìã RESULTADO DA VALIDA√á√ÉO");
console.log("==========================\n");

if (errors.length === 0) {
  console.log("üü¢ VALIDA√á√ÉO PASSOU - Sistema sincronizado e pronto!");
  console.log("\n‚úÖ TUDO FUNCIONANDO:");
  console.log("   ‚Ä¢ 18 tabelas no banco de dados");
  console.log("   ‚Ä¢ Sistema offline atualizado (v2)");
  console.log("   ‚Ä¢ Sincroniza√ß√£o inteligente configurada");
  console.log("   ‚Ä¢ PWA configurado corretamente");
  console.log("   ‚Ä¢ Capacitor pronto para Android/iOS");
  console.log("   ‚Ä¢ Scripts de build dispon√≠veis");

  console.log("\nüöÄ PR√ìXIMOS PASSOS:");
  console.log("   1. supabase db push (aplicar migra√ß√µes)");
  console.log("   2. npm run build:production (build de produ√ß√£o)");
  console.log("   3. npx cap sync (sincronizar mobile)");
  console.log("   4. npm run build:android (gerar APK)");
  console.log("   5. npm run build:ios (gerar IPA)");
} else {
  console.log("üî¥ VALIDA√á√ÉO FALTOU - Corrija os erros abaixo:");
  errors.forEach((error) => console.log("   " + error));
}

if (warnings.length > 0) {
  console.log("\n‚ö†Ô∏è AVISOS (N√£o bloqueiam, mas recomenda-se verificar):");
  warnings.forEach((warning) => console.log("   " + warning));
}

console.log("\n");

// Exit code
process.exit(errors.length > 0 ? 1 : 0);
